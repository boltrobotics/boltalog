<!DOCTYPE html>
<html>
  <head>
    <title>Log and metric reporting. Part 2 – Sergey Kapustin – </title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="In Part 1, I decided to use macros to optimize log calls. Instead of typing the macros manually, I wanted to have them auto-generated. The code generator will require event definitions such as event name, parameters, priority level and others. That information is stored in a model. Code generation will help me to:

" />
    <meta property="og:description" content="In Part 1, I decided to use macros to optimize log calls. Instead of typing the macros manually, I wanted to have them auto-generated. The code generator will require event definitions such as event name, parameters, priority level and others. That information is stored in a model. Code generation will help me to:

" />
    
    <meta name="author" content="Sergey Kapustin" />

    
    <meta property="og:title" content="Log and metric reporting. Part 2" />
    <meta property="twitter:title" content="Log and metric reporting. Part 2" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Sergey Kapustin - " href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="http://github.com/svkapustin.png?size=128" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Sergey Kapustin</a></h1>
            <p class="site-description"></p>
          </div>

          <nav>
            <a href="/">Blog</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Log and metric reporting. Part 2</h1>

  <div class="entry">
    <p>In <a href="/Logger">Part 1</a>, I decided to use macros to optimize log calls. Instead of typing the macros manually, I wanted to have them auto-generated. The code generator will require event definitions such as event name, parameters, priority level and others. That information is stored in a model. Code generation will help me to:</p>

<ul>
  <li><strong>Save time</strong><br />
My program emits quite a few events. Each event uses similar processing steps, i.e. check priority level, format the values, pass the event to the next stage. By having those common steps generated, my initial effort multiplies in value</li>
  <li><strong>Eliminate errors in code and log format</strong><br />
After I debugged my first generated macro and corresponding implementation, the subsequent ones will be replicated from the working code</li>
  <li><strong>Keep event definition and documentation co-located and in sync</strong><br />
Since I’ll use a model to define events, I might as well use that same model to describe them. The close proximity of the definition and documentation lowers the barrier of keeping the documentation up to date. A source that holds that information in one place is easier and more useful to deal with for reference and generating other artefacts from</li>
</ul>

<h3 id="code-generator">Code Generator</h3>

<p><a href="https://github.com/imatix/gsl#overview">GSL Universal Code Generator</a> exists for the purpose of code generation. Its documentation is clear, the tool is flexible and easy to use. GSL uses XML for defining models and its own scripting language for code templates.</p>

<h3 id="model">Model</h3>

<p>Here is an example model I’ll use for prototyping (<a href="https://github.com/svkapustin/strong-log/blob/master/model/log_model_example.xml#L7-L25">Github</a>):</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" ?&gt;</span>
<span class="nt">&lt;log&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">id=</span><span class="s">"1"</span> <span class="na">name=</span><span class="s">"onLogEventA"</span> <span class="na">level=</span><span class="s">"LOG_INFO"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;doc&gt;</span>Log is emitted when so and so occurs.<span class="nt">&lt;/doc&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"param1"</span> <span class="na">type=</span><span class="s">"int32_t"</span> <span class="na">doc=</span><span class="s">"description"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"param2"</span> <span class="na">type=</span><span class="s">"int8_t"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/event&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">id=</span><span class="s">"2"</span> <span class="na">name=</span><span class="s">"onLogEventB"</span> <span class="na">level=</span><span class="s">"LOG_WARNING"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"param1"</span> <span class="na">type=</span><span class="s">"uint16_t"</span> <span class="na">doc=</span><span class="s">"- description"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"param2"</span> <span class="na">type=</span><span class="s">"const std::string&amp;"</span> <span class="na">doc=</span><span class="s">"+ description"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/event&gt;</span>
    <span class="nt">&lt;event</span> <span class="na">id=</span><span class="s">"3"</span> <span class="na">name=</span><span class="s">"onLogEventC"</span> <span class="na">level=</span><span class="s">"LOG_DEBUG"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;doc&gt;</span>Log is emitted when so and so occurs.<span class="nt">&lt;/doc&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"p1"</span> <span class="na">type=</span><span class="s">"uint64_t"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"p2"</span> <span class="na">type=</span><span class="s">"const std::string&amp;"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"p3"</span> <span class="na">type=</span><span class="s">"const std::string&amp;"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"p4"</span> <span class="na">type=</span><span class="s">"uint8_t"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/event&gt;</span>
<span class="nt">&lt;/log&gt;</span>
</code></pre>
</div>
<p>The model can be structured any way you want. I target simplicity as a primary criteria. This model should:</p>

<ul>
  <li><strong>Borrow concepts</strong><br />
It is too easy to invent new concepts, the problem is that there are already so many to remember. So, instead of defining my own parameter types, I’ll use C/C++ types. For priority levels I’ll use syslog’s definitions</li>
  <li><strong>Define directly translatable components</strong><br />
For example, C++ can use STL’s string type, in the source code I’ll use it as “const std::string&amp;” per my coding style. Therefore, I chose to specify it in the model exactly how it will be used in the code. But this is a personal preference. Differently-skilled users of this model may get puzzled. A compromise has to be made. After all, the code will be auto-generated</li>
  <li><strong>Add only the minimum required</strong><br />
More stuff require more time and effort to maintain. Who wants that?</li>
</ul>

<p>Here are more specifics:</p>

<ul>
  <li><strong><em>log</em></strong> - the root of XML document</li>
  <li><strong><em>event</em></strong> - encapsulates a definition of an event</li>
  <li><strong><em>event id</em></strong> - Each event needs to be identified uniquely and compactly. The ID is an integer and will be used as an index into an array that will hold priority levels for each event. Compactness requirement is aimed for more efficient RAM/network bandwidth/storage usage, log parsing speed, etc. Note that event ID 0 will be used to define program’s priority level so as to filter out events that have lower priority than that</li>
  <li><strong><em>event name</em></strong> - The name as it will appear in the code, macro name. This will also be used to convert compact log representation to user-friendly format</li>
  <li><strong><em>event level</em></strong> - The priority level as defined in syslog(3) documentation</li>
  <li><strong><em>doc</em></strong> - This standalone element should describe the event’s purpose. For example, what program conditions exist at the moment the event is emitted, etc. The contents will also be added to source code comments</li>
  <li><strong><em>param</em></strong> - a parameter encapsulates information about a single parameter</li>
  <li><strong><em>param name</em></strong> - the name that will appear in the source code as a function parameter and in the comments. It will also be used to transform the format from compact to user-friendly</li>
  <li><strong><em>param type</em></strong> - the parameter’s C/C++ type. My requirement is to use numeric types and a constant std string reference</li>
  <li><strong><em>param doc</em></strong> - this is to describe what the parameter represents in the context of the event. It is added to source code comments</li>
</ul>

<p>That’s it. I could also add XML schema to validate the content of this model, but only when it becomes needed.</p>

<p><a href="/Logger3">Part 3</a> will describe output templates that the code generator will use during data-to-code transformation</p>

  </div>

  <div class="date">
    Written on August 25, 2017
  </div>

  
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'www-svkapustin-com';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            dsq.setAttribute('data-timestamp', +new Date());
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>


  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          



<a href="https://github.com/svkapustin"><i class="svg-icon github"></i></a>








        </footer>
      </div>
    </div>

    

  </body>
</html>
